name: Convert Python to EXE

on:
  push:
    paths:
      - 'python-files/**/*.py'
  schedule:
    - cron: '*/10 * * * *'

permissions:
  contents: write
  actions: read

jobs:
  convert:
    runs-on: windows-latest
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyInstaller
        run: pip install pyinstaller

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: python-files/**/*.py

      - name: Convert Python files to EXE
        run: |
          $files = "${{ steps.changed-files.outputs.all_changed_files }}" -split ' '
          foreach ($file in $files) {
            if ($file -match '\.py$') {
              Write-Host "Converting $file to EXE..."
              $basename = [System.IO.Path]::GetFileNameWithoutExtension($file)
              pyinstaller --onefile --distpath exe-files --name $basename $file
              Write-Host "Conversion completed: $basename.exe"
            }
          }

      - name: Commit EXE files
        if: steps.changed-files.outputs.all_changed_files != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add exe-files/*.exe
          git commit -m "Add converted EXE files" || echo "No new files to commit"
          git push

      - name: Clean up Python files
        if: steps.changed-files.outputs.all_changed_files != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          $files = "${{ steps.changed-files.outputs.all_changed_files }}" -split ' '
          foreach ($file in $files) {
            if (Test-Path $file) {
              git rm $file
            }
          }
          if (git diff --staged --quiet) {
            Write-Host "No files to clean up"
          } else {
            git commit -m "Clean up converted Python files"
            git push
          }

  cleanup:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Delete old EXE files (older than 10 minutes)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Find and delete EXE files older than 10 minutes
          find exe-files -name "*.exe" -type f -mmin +10 -delete
          
          # Commit the changes if any files were deleted
          git add -A
          if ! git diff --staged --quiet; then
            git commit -m "Clean up EXE files older than 10 minutes"
            git push
          else
            echo "No old files to clean up"
          fi
