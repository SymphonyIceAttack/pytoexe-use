name: Convert Python to EXE

on:
  push:
    paths:
      - 'python-files/**/*.py'

permissions:
  contents: write
  actions: read

jobs:
  convert:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyInstaller
        run: pip install pyinstaller

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: python-files/**/*.py

      - name: Convert Python files to EXE
        run: |
          $files = "${{ steps.changed-files.outputs.all_changed_files }}" -split ' '
          foreach ($file in $files) {
            if ($file -match '\.py$') {
              Write-Host "Converting $file to EXE..."
              $basename = [System.IO.Path]::GetFileNameWithoutExtension($file)
              pyinstaller --onefile --distpath dist --name $basename $file
              Write-Host "Conversion completed: $basename.exe"
            }
          }

      - name: Upload EXE artifacts
        uses: actions/upload-artifact@v4
        with:
          name: converted-executables
          path: dist/*.exe
          retention-days: 7

      - name: Clean up Python files
        if: steps.changed-files.outputs.all_changed_files != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          $files = "${{ steps.changed-files.outputs.all_changed_files }}" -split ' '
          foreach ($file in $files) {
            if (Test-Path $file) {
              git rm $file
            }
          }
          if (git diff --staged --quiet) {
            Write-Host "No files to clean up"
          } else {
            git commit -m "Clean up converted Python files"
            git push
          }
